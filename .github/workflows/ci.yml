name: CI

on:
    push:
        branches:
            - '**'
        paths:
            - 'api/**'
            - 'app/**'
            - 'oas/**'
            - 'docker/**'
            - 'compose.yaml'
            - '.castor/**'
            - 'castor.php'
            - '.spectral.yaml'
            - '.github/workflows/ci.yml'

# Cancel in-progress runs for the same branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    PHP_VERSION: '8.4'
    PHP_EXTENSIONS: mbstring, xml, ctype, iconv, intl, pdo_pgsql, pgsql, amqp
    NODE_VERSION: '22'
    PNPM_VERSION: '10'

jobs:
    # =============================================================================
    # BUILD STAGE
    # =============================================================================

    docker:
        name: Build / Docker Images
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Build Docker images
                run: docker compose build

            -   name: Start Docker Compose stack
                run: docker compose up -d

            -   name: Wait for services to be ready
                run: |
                    timeout 60 bash -c 'until docker compose ps | grep -q "healthy\|running"; do sleep 2; done' || true

            -   name: Check running containers
                run: docker compose ps

            -   name: Show logs if failed
                if: failure()
                run: docker compose logs

            -   name: Stop Docker Compose stack
                if: always()
                run: docker compose down -v

    # =============================================================================
    # TEST STAGE - API
    # =============================================================================

    api-static-analysis:
        name: Test / API Static Analysis
        runs-on: ubuntu-latest
        needs: [docker]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP extensions cache environment
                id: php-extensions-cache-env
                uses: shivammathur/cache-extensions@v1
                with:
                    php-version: ${{ env.PHP_VERSION }}
                    extensions: ${{ env.PHP_EXTENSIONS }}
                    key: php-extensions-v1

            -   name: Cache PHP extensions
                uses: actions/cache@v4
                with:
                    path: ${{ steps.php-extensions-cache-env.outputs.dir }}
                    key: ${{ steps.php-extensions-cache-env.outputs.key }}
                    restore-keys: |
                        ${{ steps.php-extensions-cache-env.outputs.key }}

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ env.PHP_VERSION }}
                    extensions: ${{ env.PHP_EXTENSIONS }}
                    coverage: none
                    tools: castor

            -   name: Cache Composer packages
                uses: actions/cache@v4
                with:
                    path: api/vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('api/composer.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-composer-

            -   name: Install Composer dependencies
                run: castor api:install

            -   name: Restore PHPStan cache
                uses: actions/cache/restore@v4
                with:
                    path: api/var/cache/.phpstan.cache
                    key: phpstan-result-cache-${{ github.run_id }}
                    restore-keys: |
                        phpstan-result-cache-

            -   name: Restore Rector cache
                uses: actions/cache/restore@v4
                with:
                    path: api/var/cache/.rector.cache
                    key: rector-result-cache-${{ github.run_id }}
                    restore-keys: |
                        rector-result-cache-

            -   name: Restore ECS cache
                uses: actions/cache/restore@v4
                with:
                    path: api/var/cache/.ecs.cache
                    key: ecs-result-cache-${{ github.run_id }}
                    restore-keys: |
                        ecs-result-cache-

            -   name: Run Rector
                run: castor rector --ci

            -   name: Run ECS
                run: castor ecs --ci

            -   name: Run Linters
                run: castor api:lint

            -   name: Run PHPStan
                run: castor phpstan --ci

            -   name: Save PHPStan cache
                uses: actions/cache/save@v4
                if: ${{ !cancelled() }}
                with:
                    path: api/var/cache/.phpstan.cache
                    key: phpstan-result-cache-${{ github.run_id }}

            -   name: Save Rector cache
                uses: actions/cache/save@v4
                if: ${{ !cancelled() }}
                with:
                    path: api/var/cache/.rector.cache
                    key: rector-result-cache-${{ github.run_id }}

            -   name: Save ECS cache
                uses: actions/cache/save@v4
                if: ${{ !cancelled() }}
                with:
                    path: api/var/cache/.ecs.cache
                    key: ecs-result-cache-${{ github.run_id }}

    api-test:
        name: Test / API Unit & Integration Tests
        runs-on: ubuntu-latest
        needs: [api-static-analysis]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP extensions cache environment
                id: php-extensions-cache-env
                uses: shivammathur/cache-extensions@v1
                with:
                    php-version: ${{ env.PHP_VERSION }}
                    extensions: ${{ env.PHP_EXTENSIONS }}
                    key: php-extensions-v1

            -   name: Cache PHP extensions
                uses: actions/cache@v4
                with:
                    path: ${{ steps.php-extensions-cache-env.outputs.dir }}
                    key: ${{ steps.php-extensions-cache-env.outputs.key }}
                    restore-keys: |
                        ${{ steps.php-extensions-cache-env.outputs.key }}

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ env.PHP_VERSION }}
                    extensions: ${{ env.PHP_EXTENSIONS }}
                    coverage: xdebug
                    tools: castor

            -   name: Cache Composer packages
                uses: actions/cache@v4
                with:
                    path: api/vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('api/composer.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-composer-

            -   name: Install Composer dependencies
                run: castor api:install

            -   name: Start PostgreSQL service
                run: castor infra:up --service postgres

            -   name: Reset test database
                run: castor db:reset -t

            -   name: Run PHPUnit with coverage
                run: castor api:test -o

            -   name: Stop PostgreSQL service
                if: always()
                run: castor infra:destroy --force

    api-security-audit:
        name: Test / API Security Audit
        runs-on: ubuntu-latest
        needs: [docker]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP extensions cache environment
                id: php-extensions-cache-env
                uses: shivammathur/cache-extensions@v1
                with:
                    php-version: ${{ env.PHP_VERSION }}
                    extensions: ${{ env.PHP_EXTENSIONS }}
                    key: php-extensions-v1

            -   name: Cache PHP extensions
                uses: actions/cache@v4
                with:
                    path: ${{ steps.php-extensions-cache-env.outputs.dir }}
                    key: ${{ steps.php-extensions-cache-env.outputs.key }}
                    restore-keys: |
                        ${{ steps.php-extensions-cache-env.outputs.key }}

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ env.PHP_VERSION }}
                    extensions: ${{ env.PHP_EXTENSIONS }}
                    coverage: none
                    tools: castor

            -   name: Cache Composer packages
                uses: actions/cache@v4
                with:
                    path: api/vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('api/composer.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-composer-

            -   name: Install Composer dependencies
                run: castor api:install

            -   name: Run Composer security audit
                run: castor api:audit

    # =============================================================================
    # TEST STAGE - APP
    # =============================================================================

    app-static-analysis:
        name: Test / App Static Analysis
        runs-on: ubuntu-latest
        needs: [docker]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: ${{ env.PNPM_VERSION }}

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: ${{ env.NODE_VERSION }}
                    cache: 'pnpm'
                    cache-dependency-path: 'app/pnpm-lock.yaml'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile
                working-directory: app

            -   name: Generate API client
                run: pnpm generate:api
                working-directory: app

            -   name: Run Biome lint
                run: pnpm lint
                working-directory: app

            -   name: Run TypeScript type check
                run: pnpm exec tsc --noEmit
                working-directory: app

    app-test:
        name: Test / App Unit Tests
        runs-on: ubuntu-latest
        needs: [app-build]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: ${{ env.PNPM_VERSION }}

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: ${{ env.NODE_VERSION }}
                    cache: 'pnpm'
                    cache-dependency-path: 'app/pnpm-lock.yaml'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile
                working-directory: app

            -   name: Generate API client
                run: pnpm generate:api
                working-directory: app

            -   name: Run tests with coverage
                run: pnpm test:coverage
                working-directory: app

    app-security-audit:
        name: Test / App Security Audit
        runs-on: ubuntu-latest
        needs: [docker]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: ${{ env.PNPM_VERSION }}

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: ${{ env.NODE_VERSION }}

            -   name: Run pnpm security audit
                run: pnpm audit
                working-directory: app

    # =============================================================================
    # BUILD STAGE - APP
    # =============================================================================

    app-build:
        name: Build / App Production Build
        runs-on: ubuntu-latest
        needs: [app-static-analysis]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: ${{ env.PNPM_VERSION }}

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: ${{ env.NODE_VERSION }}
                    cache: 'pnpm'
                    cache-dependency-path: 'app/pnpm-lock.yaml'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile
                working-directory: app

            -   name: Generate API client
                run: pnpm generate:api
                working-directory: app

            -   name: Build application
                run: pnpm build
                working-directory: app

            -   name: Upload build artifact
                uses: actions/upload-artifact@v4
                with:
                    name: app-dist
                    path: app/dist
                    retention-days: 7

    storybook-build:
        name: Build / Storybook
        runs-on: ubuntu-latest
        needs: [app-static-analysis]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: ${{ env.PNPM_VERSION }}

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: ${{ env.NODE_VERSION }}
                    cache: 'pnpm'
                    cache-dependency-path: 'app/pnpm-lock.yaml'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile
                working-directory: app

            -   name: Generate API client
                run: pnpm generate:api
                working-directory: app

            -   name: Build Storybook
                run: pnpm build-storybook
                working-directory: app

            -   name: Upload Storybook artifact
                uses: actions/upload-artifact@v4
                with:
                    name: storybook
                    path: app/storybook-static
                    retention-days: 7

    # =============================================================================
    # TEST STAGE - OAS
    # =============================================================================

    oas-lint:
        name: Test / OpenAPI Lint
        runs-on: ubuntu-latest
        needs: [docker]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Lint OpenAPI spec with Spectral
                run: |
                    docker run --rm -v ${{ github.workspace }}:/tmp \
                      stoplight/spectral lint \
                      --format github-actions \
                      --ruleset /tmp/.spectral.yaml \
                      /tmp/oas/openapi.yaml

    # =============================================================================
    # REVIEW STAGE
    # =============================================================================

    claude-code-review:
        name: Review / Claude Code Review
        # Temporarily disabled
        if: false
        runs-on: ubuntu-latest
        needs: [api-static-analysis, app-static-analysis, api-test, app-test]

        permissions:
            contents: read
            pull-requests: read
            issues: read
            id-token: write

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4
                with:
                    fetch-depth: 1

            -   name: Run Claude Code Review
                id: claude-review
                uses: anthropics/claude-code-action@v1
                with:
                    claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                    prompt: |
                        REPO: ${{ github.repository }}
                        PR NUMBER: ${{ github.event.pull_request.number }}

                        Please review this pull request and provide feedback on:
                        - Code quality and best practices
                        - Potential bugs or issues
                        - Performance considerations
                        - Security concerns
                        - Test coverage

                        Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

                        Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

                    claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
