name: Quality

on:
    push:
        branches:
            - '**'
        paths:
            - 'api/**'
            - 'app/**'
            - 'oas/**'
            - '.castor/**'
            - 'castor.php'
            - '.github/workflows/quality.yml'

jobs:
    # =============================================================================
    # API Jobs
    # =============================================================================

    api-static-analysis:
        name: API / Static Analysis
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP extensions cache environment
                id: php-extensions-cache-env
                uses: shivammathur/cache-extensions@v1
                with:
                    php-version: '8.4'
                    extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, pgsql, amqp
                    key: php-extensions-v1

            -   name: Cache PHP extensions
                uses: actions/cache@v4
                with:
                    path: ${{ steps.php-extensions-cache-env.outputs.dir }}
                    key: ${{ steps.php-extensions-cache-env.outputs.key }}
                    restore-keys: |
                        ${{ steps.php-extensions-cache-env.outputs.key }}

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.4'
                    extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, pgsql, amqp
                    coverage: none
                    tools: castor

            -   name: Cache Composer packages
                uses: actions/cache@v4
                with:
                    path: api/vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-composer-

            -   name: Restore PHPStan cache
                uses: actions/cache/restore@v4
                with:
                    path: api/var/cache/.phpstan.cache
                    key: phpstan-result-cache-${{ github.run_id }}
                    restore-keys: |
                        phpstan-result-cache-

            -   name: Restore Rector cache
                uses: actions/cache/restore@v4
                with:
                    path: api/var/cache/.rector.cache
                    key: rector-result-cache-${{ github.run_id }}
                    restore-keys: |
                        rector-result-cache-

            -   name: Restore ECS cache
                uses: actions/cache/restore@v4
                with:
                    path: api/var/cache/.ecs.cache
                    key: ecs-result-cache-${{ github.run_id }}
                    restore-keys: |
                        ecs-result-cache-

            -   name: Install Composer dependencies
                run: castor install

            -   name: Run Rector
                run: castor rector --ci

            -   name: Run ECS
                run: castor ecs --ci

            -   name: Run Linters
                run: castor lint

            -   name: Run Doctrine Schema Validation
                run: castor schema

            -   name: Run PHPStan
                run: castor phpstan --ci

            -   name: Save PHPStan cache
                uses: actions/cache/save@v4
                if: ${{ !cancelled() }}
                with:
                    path: api/var/cache/.phpstan.cache
                    key: phpstan-result-cache-${{ github.run_id }}

            -   name: Save Rector cache
                uses: actions/cache/save@v4
                if: ${{ !cancelled() }}
                with:
                    path: api/var/cache/.rector.cache
                    key: rector-result-cache-${{ github.run_id }}

            -   name: Save ECS cache
                uses: actions/cache/save@v4
                if: ${{ !cancelled() }}
                with:
                    path: api/var/cache/.ecs.cache
                    key: ecs-result-cache-${{ github.run_id }}

    api-test:
        name: API / Test
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP extensions cache environment
                id: php-extensions-cache-env
                uses: shivammathur/cache-extensions@v1
                with:
                    php-version: '8.4'
                    extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, pgsql, amqp
                    key: php-extensions-v1

            -   name: Cache PHP extensions
                uses: actions/cache@v4
                with:
                    path: ${{ steps.php-extensions-cache-env.outputs.dir }}
                    key: ${{ steps.php-extensions-cache-env.outputs.key }}
                    restore-keys: |
                        ${{ steps.php-extensions-cache-env.outputs.key }}

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.4'
                    extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, pgsql, amqp
                    coverage: xdebug
                    tools: castor

            -   name: Cache Composer packages
                uses: actions/cache@v4
                with:
                    path: api/vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-composer-

            -   name: Start PostgreSQL service
                run: castor up --service postgres

            -   name: Install Composer dependencies
                run: castor install

            -   name: Reset test database
                run: castor database:reset -t

            -   name: Run PHPUnit with coverage
                run: castor test -o

            -   name: Stop PostgreSQL service
                if: always()
                run: castor destroy --force

    api-security:
        name: API / Security Audit
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP extensions cache environment
                id: php-extensions-cache-env
                uses: shivammathur/cache-extensions@v1
                with:
                    php-version: '8.4'
                    extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, pgsql, amqp
                    key: php-extensions-v1

            -   name: Cache PHP extensions
                uses: actions/cache@v4
                with:
                    path: ${{ steps.php-extensions-cache-env.outputs.dir }}
                    key: ${{ steps.php-extensions-cache-env.outputs.key }}
                    restore-keys: |
                        ${{ steps.php-extensions-cache-env.outputs.key }}

            -   name: Set up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.4'
                    extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, pgsql, amqp
                    coverage: none
                    tools: castor

            -   name: Cache Composer packages
                uses: actions/cache@v4
                with:
                    path: api/vendor
                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-composer-

            -   name: Install Composer dependencies
                run: castor install

            -   name: Run Composer security audit (production)
                run: castor dependencies

    # =============================================================================
    # App Jobs
    # =============================================================================

    app-lint:
        name: App / Lint & Type Check
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 10

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '22'
                    cache: 'pnpm'
                    cache-dependency-path: 'app/pnpm-lock.yaml'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile
                working-directory: app

            -   name: Generate API client
                run: pnpm generate:api
                working-directory: app

            -   name: Run Biome lint
                run: pnpm lint
                working-directory: app

            -   name: Run TypeScript type check
                run: pnpm exec tsc --noEmit
                working-directory: app

    app-test:
        name: App / Test
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 10

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '22'
                    cache: 'pnpm'
                    cache-dependency-path: 'app/pnpm-lock.yaml'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile
                working-directory: app

            -   name: Generate API client
                run: pnpm generate:api
                working-directory: app

            -   name: Run tests with coverage
                run: pnpm test:coverage
                working-directory: app

    app-build:
        name: App / Build
        runs-on: ubuntu-latest
        needs: [app-lint, app-test]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 10

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '22'
                    cache: 'pnpm'
                    cache-dependency-path: 'app/pnpm-lock.yaml'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile
                working-directory: app

            -   name: Generate API client
                run: pnpm generate:api
                working-directory: app

            -   name: Build application
                run: pnpm build
                working-directory: app

            -   name: Upload build artifact
                uses: actions/upload-artifact@v4
                with:
                    name: app-dist
                    path: app/dist
                    retention-days: 7

    app-storybook:
        name: App / Build Storybook
        runs-on: ubuntu-latest
        needs: [app-lint]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 10

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '22'
                    cache: 'pnpm'
                    cache-dependency-path: 'app/pnpm-lock.yaml'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile
                working-directory: app

            -   name: Generate API client
                run: pnpm generate:api
                working-directory: app

            -   name: Build Storybook
                run: pnpm build-storybook
                working-directory: app

            -   name: Upload Storybook artifact
                uses: actions/upload-artifact@v4
                with:
                    name: storybook
                    path: app/storybook-static
                    retention-days: 7
